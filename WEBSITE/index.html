<!DOCTYPE html>
<head>
	<title>Artwork Explorer</title>
	<link rel='stylesheet' id='font-css'  href='./css/style.css' type='text/css' media='all' />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
	<link href='https://unpkg.com/dc@3.0.10/dc.css' rel='stylesheet' type='text/css'>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<style>

	.info {
	    padding: 6px 8px;
	    font: 14px/16px Arial, Helvetica, sans-serif;
	    background: white;
	    background: rgba(255,255,255,0.8);
	    box-shadow: 0 0 15px rgba(0,0,0,0.2);
	    border-radius: 5px;
	}
	.info h4 {
	    margin: 0 0 5px;
	    color: #777;
	}

	.legend {
	    line-height: 18px;
	    color: #555;
	}
	.legend i {
	    width: 18px;
	    height: 18px;
	    float: left;
	    margin-right: 8px;
	    opacity: 0.7;
	}

	.w3-bar,button {font-family: "Montserrat", sans-serif}
	</style>
</head>
<body>
	<div id='wrapper'>
		<div class="w3-top">
			<div class="w3-bar w3-lime w3-card w3-left-align w3-large">
				<a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-lime" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
				<a href="#" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Map</a>
				<a href="#" class="w3-bar-item w3-button w3-padding-large w3-white">About</a>
				<a href="#" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Analysis</a>
				<a href="#" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Contact</a>
			</div>

			<!-- Navbar on small screens -->
			<div id="navDemo" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
				<a href="#" class="w3-bar-item w3-button w3-padding-large">Link 1</a>
				<a href="#" class="w3-bar-item w3-button w3-padding-large">Link 2</a>
				<a href="#" class="w3-bar-item w3-button w3-padding-large">Link 3</a>
				<a href="#" class="w3-bar-item w3-button w3-padding-large">Link 4</a>
			</div>
			<div id="titleHeader">
				<h2 class="title-header">Met Museum Artwork Visualiser</h2>
		</div>
		</div>
		<div id='main'>
			<div id='map-canvas' ></div>
			<div id='charts'>
				<div id='year-chart'>By Starting Year of Artwork
					<a class='reset'
					href='javascript:yearChart.filterAll();dc.redrawAll();'
					style="display: none; float: right; margin-right: 50px;">reset</a>
				</div>
				<div id='classification-chart'>Classifications of Artwork
					<a class='reset'
					href='javascript:classificationChart.filterAll();dc.redrawAll();'
					style="display: none; float: right; margin-right: 20px;">reset</a>
					</span>
				</div>
			</div>
		</div>
	</div>

<!-- The Javascript from external websites gets Loaded Here -->
<script type='text/javascript' src='http://code.jquery.com/jquery-1.10.2.min.js?ver=1.10.2'></script>
<script type="text/javascript" src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/dc@3.0.10/dc.js"></script>
<script type="text/javascript" src="/js/jquery.blockUI.js"></script>

<!--This section will create an interactive visualisation using Leaflet.js for a map and dc.js for charts -->
<script type="text/javascript">
var fullData; //the entire dataset, defined so it can be loaded in background
var yearChart, //charts defined globally to allow resetting through text in divs
		classificationChart;
addMap(); //loads map, retrieves country polygons, and calls drawCharts

var url = "http://dev.spatialdatacapture.org:8872/data"

d3.json(url,function (data){  //API CALL ON FULL DATASET
	fullData = data;
	console.log("full data loaded");
	$("input[name=dataset]").attr('disabled', false);
});

function addMap(){
	var map = new L.map('map-canvas').setView([0, 0], 2);
	var layer = new L.StamenTileLayer("toner-background", {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',});
	map.addLayer(layer);

	var selecter = L.control({position: 'bottomleft'});
	selecter.onAdd = function(map){
		this.div = L.DomUtil.create('div', 'info selecter')
		selecter.update();
		return this.div;
	};

	selecter.update = function () {
		var clusters =['cluster1','cluster2']
		clusterhtml=''
		for (var i = 0; i < clusters.length; i++) {
			clusterhtml+= '<option value='+clusters[i]+'>'+clusters[i]+'</option>'
		};
		this.div.innerHTML='<h4>Clusters:</h4>'+
		'<form>'+
		'<input type="radio" name="dataset" value="full"> Full dataset<br>'+
		'<input type="radio" name="dataset" value="cluster" checked> Cluster '+
		'<select name="cluster">' +
		clusterhtml+
		'</select>'+
		'</form>'
		;

	};
	selecter.addTo(map);
	$("input[name=dataset]").attr('disabled', true);

	function loadData(){
		var newData=''
		if ($("input[name=dataset]:checked").val()==="full") {
			newData="full"
			drawCharts(fullData); //putting it up here for now, but structure depends on API calls
			$('#map-canvas').unblock();
		} else {
			newData=$("select[name=cluster] option:checked").val()
			d3.json(url,function(json){
			drawCharts(json);  //tihs will be the API call to run the drawCharts function with the newData set. currently grabs base data just for something to be loaded.
			$('#map-canvas').unblock();
			});
		};
		console.log("the selected dataset is " + newData)
	};

	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {
		this._legenddiv = L.DomUtil.create('div', 'info legend');
		this.update();
		return this._legenddiv;
	};

	var info = L.control();
	
	var showRecord; //function created here, but defined in data section

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
		this.update();
		return this._div;
	}

	$.getJSON("maps/WorldCountriesMap_json.geojson", function (data) {
		countries = L.geoJson(data, {
			style: countryDefaultStyle,
			onEachFeature: countryInteractions
		});
		countries.addTo(map);
		$('#map-canvas').block({ message: '<h1> Loading Data</h1>' });
		$("form :input").change(function(){
			$('#map-canvas').block({ message: '<h1> Loading Data</h1>' });
			loadData()
		});

		loadData()

	});

	function countryDefaultStyle(feature) {   //loads a default style, to be replaced when the data has loaded
		return {
			// fillColor: color(artworksCountryCount(feature)),    //loads as blank and then updated
			weight: 2,
			opacity: 1,
			color: 'gray',
			dashArray: '',
			fillOpacity: 0.6
		}
	}

	function countryInteractions(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: clickFeature//zoomToFeature     	//zoom part of cities functionality
		});
	}
	
	function clickFeature(e){
		showRecord(e)
	}
// The following code is for cities functionality
	// $.getJSON("maps/countries.geojson", function (data) {
	// 	cities = L.geoJson(data, {
	// 		style: cityStyle,
	// 		onEachFeature: cityInteractions
	// 	});
	// });
	//
	// function cityStyle(feature) {
	// 	return {
	// 		fillColor: color(artworksCityCount(feature)),
	// 		weight: 2,
	// 		opacity: 1,
	// 		color: 'gray',
	// 		dashArray: '',
	// 		fillOpacity: 0.6
	// 	};
	// }
	//
	// function cityInteractions(feature, layer) {
	// 	layer.on({
	// 		mouseover: highlightFeature,
	// 		mouseout: resetHighlight,
	// 	});
	// }
	//
	
	function highlightFeature(e) {
		var layer = e.target;
		layer.setStyle({color: "white",weight: 4});
		layer.bringToFront();
		info.update(layer.feature);
	}

	function resetHighlight(e) {
		// if (mapZoom) {
		// 	cities.resetStyle(e.target);
		// } else {
			countries.resetStyle(e.target);
		// }

		info.update();
	}

	// function zoomToFeature(e) {
	// 	var layer = e.target;
	// 	countryDimension.filter(function (d) {return d === layer.feature.properties.GMI_CNTRY ;});
	// 	dc.renderAll();
	// 	map.fitBounds(layer.getBounds());
	// 	mapZoom=true;
	// 	countries.remove();
	// 	cities.addTo(map);  //how do i chose a subsection of cities
	// 	updateMap();
	// }

	// zoomOut= function(){
	// 	countryDimension.filterAll();
	// 	mapZoom=false;
	// 	countries.addTo(map);
	// 	cities.remove();
	// 	map.setView([0, 0], 2);
	// 	updateMap();
	// }

	function drawCharts(response) {
		var artworks = crossfilter(response), //crossfilter object
				all = artworks.groupAll();

		var yearRounding = 25;       //object year data is rounded to the number of years as given here.
				yearDimension = artworks.dimension(function(d) {return d['object_begin_date']- d['object_begin_date'] % yearRounding;}),
				yearGroup = yearDimension.group();
		yearChart = dc.barChart('#year-chart'); //charts defined globally to allow resetting through text in divs


		var classificationDimension = artworks.dimension(function(d) {return d.Class_General;}),
				classificationGroup = classificationDimension.group();
		classificationChart = dc.pieChart('#classification-chart'); //charts defined globally to allow resetting through text in divs

		var countryDimension = artworks.dimension(function(d) {return d.country;}),
				countryGroup = countryDimension.group();


		// var cityDimension = artworks.dimension(function(d) {return d.CityMatch;}),
		// 		cityGroup = cityDimension.group();

		var		color = d3.scaleThreshold() //a scaling function for the map colouring
				.range(["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"]);

		var mapZoom = false; //toggles whether country or city data displayed

		addCharts(); //creates crossfilter charts
		finaliseMap(); //adds the map elements that relied on data loading - the legend, info control, and colouring
		updateMap();


		yearChart.on('filtered', function(chart) {
			updateMap()
		});

		classificationChart.on('filtered', function(chart) {
			updateMap()
		});
	
		function updateMap() {  //redraws map when filters change
			// if (mapZoom) {
			// 	colorDomain(cityGroup.all());
			// 	cities.eachLayer(function(featureInstanceLayer) {
			// 		featureInstanceLayer.setStyle({
			// 			fillColor: color(artworksCityCount(featureInstanceLayer.feature))
			// 		});
			//
			// 	});
			//
			// } else {
				colorDomain(countryGroup.all());
				countries.eachLayer(function(featureInstanceLayer) {
					featureInstanceLayer.setStyle({
						fillColor: color(artworksCountryCount(featureInstanceLayer.feature))
					});
				});
			// };
			legend.update();
			info.update();
		}

		function artworksCount(d) {
			// if (mapZoom) {
			// 	return artworksCityCount(d);
			// } else {
				return artworksCountryCount(d);
			// }
		}

		// function artworksCityCount(d){
		// 	var v = cityGroup.all().filter(function(item) { return item.key === d.properties.NAME; })  //city_Id
		// 	if (v.length==0)
		// 	{return (0)}
		// 	else
		// 	{return (v[0].value)}
		// }

		function artworksCountryCount(d){
			var v = countryGroup.all().filter(function(item) { return item.key === d.properties.NAME; })  //city name
			if (v.length==0)
			{return (0)}
			else
			{return (v[0].value)}
		}

		function colorDomain(array){ //this function is passed an array of values and creates a logarithmic scale for the non-zero elements.
			var values = array.map(e => e["value"]).filter(function(a){return a >0;});
			values.sort(function(a, b){return a-b});
			var observations = values.length
			var breaks = color.range().length - 2 // always one less break than range, less another break set aside for zero values
			//var quantileSize = Math.floor (observations/(breaks+1))  //this was an alternative that split into equal quantiles
			var domain =[0];
			var max = values[observations-1];
			for (var i = 0; i < breaks; i++) {
				//var unrounded = values[quantileSize * (i+1) - 1];    //alternative to split into equal quantiles
				var unrounded = Math.exp((Math.log(max)/breaks * (i+1)));
				var nextBreak = Number(unrounded.toPrecision(unrounded>100? 2:1));

				domain.push(nextBreak);
			}

			color.domain(domain);
		}



		function addCharts(){
			yearChart /* dc.barChart('#year-chart', 'chartGroup') */
			// .width()
			// .height()
			.margins({top: 10, right: 50, bottom: 30, left: 40})
			.dimension(yearDimension)
			.group(yearGroup)
			.elasticY(true)
			.round(dc.round.floor)
			.alwaysUseRounding(true)
			.x(d3.scaleLinear().domain([-0, 2000]))
			.renderHorizontalGridLines(true)
			.yAxisLabel("Artworks")
			.xAxisLabel("Year")
			.barPadding(0)
	//		.turnOnControls(true)

			classificationChart
			.radius(80)
			.dimension(classificationDimension)
			.group(classificationGroup)
		//	.turnOnControls(true)
			// ClassificationRowChart /* dc.Chart('#classification-chart', 'chartGroup') */
			//        // .width(180)
			//       //  .height(180)
			//         .margins({top: 0, left: 0, right: 0, bottom: 0})
			//         .group(ClassificationGroup)
			//         .dimension(ClassificationDimension)
			// 				.ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
			// 			//	.label(function (d) {
			// 				//            return d.key.split('.')[1];
			// 			//	        })
			// 			//	.title(function (d) {
			//       //    return d.value;
			//        // })
			//         .elasticX(true)
			//         .xAxis().ticks(4);

			dc.renderAll();
		}

		function finaliseMap() {
			colorDomain(countryGroup.all());
			legend.update = function () {
				grades = color.domain(),
				labels = [];
				grades.unshift(0);
				// loop through our density intervals and generate a label with a colored square for each interval
				this._legenddiv.innerHTML=''
				for (var i = 0; i < grades.length; i++) {
					this._legenddiv.innerHTML +=
					'<i style="background:' + color(i==0 ? grades[i]-1 : grades[i] + 0.001) + '"></i> ' +
					grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : (i==0 ? '<br>':'+'));
				}
			};

			legend.addTo(map);

			// method that we will use to update the control based on feature properties passed
			info.update = function (d) {
				this._div.innerHTML = '<h4>Artworks</h4>' + '<b>' + all.value() +'</b><br/>'+(d ?
				'<b>' + d.properties.NAME + '</b><br/>' + artworksCount(d) + ' artworks'
				: 'Hover over a country');
			};

			info.addTo(map);

			function countryStyle(feature) {   //choropleth styling
				return {
					fillColor: color(artworksCountryCount(feature)),
					weight: 2,
					opacity: 1,
					color: 'gray',
					dashArray: '',
					fillOpacity: 0.6
				}
			}

			L.Util.setOptions(countries,{style:countryStyle})
			
			showRecord=function (e){
				var layer = e.target;
				countryDimension.filter(function (d) {return d === layer.feature.properties.NAME ;});
				var records =countryDimension.top(Infinity);
				var length = Math.min(20, records.length)
				function shuffle(array) {
					var results = new Array(length)
					var i = array.length
					while(0!=length) {
						var j = Math.floor(Math.random() * (i));
						i--;
						length--;
						var temp = array[i];
						array[i] = array[j];
						array[j] = temp;
						results[length]=array[i]
					}
					return results
				}
				countryDimension.filterAll();
				console.log(shuffle(records))
				
			}	
		}


	}
}

function myFunction() {
  var x = document.getElementById("navDemo");
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
  } else {
    x.className = x.className.replace(" w3-show", "");
  }
}

</script>

</body>
</html>
