<!DOCTYPE html>
<head>
	<title>Artwork Explorer</title>
	<!-- <link rel='stylesheet' id='font-css'  href='http://fonts.googleapis.com/css?family=Roboto:400,300,100' type='text/css' media='all' /> -->
	<link rel='stylesheet' id='font-css'  href='./css/style.css' type='text/css' media='all' />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
	<link href='https://unpkg.com/dc@3.0.10/dc.css' rel='stylesheet' type='text/css'>
	<style>
		.leaflet-overlay-pane svg path{
		    pointer-events: auto;
		}
	</style>
</head>
<body>
<div id='wrapper'>
     <div id='map-canvas'></div>
		 <div id="controlPanel">
				<button type="button" onclick="zoomOut()">Zoom Out</button>
		 </div>
		 <div id="titleHeader">
     	 <h1>FIDT: Flickr Interactive Display Tool</h1>
     </div>
     <!-- <div id="displayInfo">
     		<div>
     		<h3>Display by Camera Type</h3>
     		<p>
     			<a href="#" id="iPhoneLink">iPhone</a>
     		</p>

     		<p>
     			<small>
     				<a href="#" id="resetLink">Reset Map</a>
     				<a href="#" id="clearLink" class="right">Clear all Markers</a>
     			</small>
     		</p>
     		</div> -->
			 <div id='year-chart'></div>
		 </div>

     <div id="displayWrapper">
     		<div><span id="photoNum">0</span> photos returned</div>
     </div>
		 <!-- <div class="infobox">
			<p>Here is where we will say something.</p>
		</div> -->
</div>

<!-- The Javascript from external websites gets Loaded Here -->
<script type='text/javascript' src='http://code.jquery.com/jquery-1.10.2.min.js?ver=1.10.2'></script>
<script type="text/javascript" src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/dc@3.0.10/dc.js"></script>


<!--This section will create a Map using Leaflet.js  -->
<script type="text/javascript">
var map //leaflet obj
var yearChart = dc.barChart('#year-chart');


var map_level = "world"
var maps ={world:"maps/continent.geojson",continent:"maps/countries.geojson",country:"maps/cities.geojson" }

addLmaps()

d3.csv("data/MetCountry.csv",drawCharts)  //REPLACE LOCAL DATA WITH API RESPONSES

function addLmaps() {
	map = new L.map('map-canvas').setView([0, 0], 2);
	var layer = new L.StamenTileLayer("toner-background", {
		attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
	});
	map.addLayer(layer);

	L.svg({clickable:true}).addTo(map);
}

function drawCharts(response) {

	var artworks = crossfilter(response);
	var all = artworks.groupAll();
	var yearDimension = artworks.dimension(function(d) {return d['Object Begin Date'];});
	var areaDimension = artworks.dimension(function(d) {return d.Country;});
	//	var ClassificationDimension = artworks.dimension(function(d) {return d.Classification;});

	var yearGroup = yearDimension.group()
	var areaGroup = areaDimension.group()

	yearChart /* dc.barChart('#year-chart', 'chartGroup') */
	// .width()
	// .height()
	.margins({top: 10, right: 50, bottom: 30, left: 40})
	.dimension(yearDimension)
	.group(yearGroup)
	.elasticY(true)
	.round(dc.round.floor)
	.alwaysUseRounding(true)
	.x(d3.scaleLinear().domain([-5000, 2020]))
	.renderHorizontalGridLines(true)

	dc.renderAll();
	d3.json(maps[map_level],drawFeatures)

	function projectPoint(x, y) {
		var point = map.latLngToLayerPoint(new L.LatLng(y, x));
		this.stream.point(point.x, point.y);
	}

	function drawFeatures(data) {
		var svg = d3.select("#map-canvas").select("svg")
		.attr("pointer-events", "auto")

		// d3.select("#map-canvas").on('mousemove', myMouseMoveFunction)    //trying to add an infobox to be defined

		var g = svg.select("g")

		var transform = d3.geoTransform({point: projectPoint});
		var path = d3.geoPath().projection(transform);

		var color = d3.scaleQuantize()
		.domain([0, areaGroup.top(1)[0].value])  //this scales values to the max for the filtered group so not comparable over time
		.range(d3.schemeCategory10) //this is a set of colours removed in v5. needs to be upgraded somehow  or color brewer used.
		//d3.schemeCategory10)

		var featureElement = g.selectAll("path")
		.data(data.features)
		.enter()
		.append("path")
		.attr("stroke", "gray")
		.attr("fill", d => color(areaGroup.all().filter(function(item) { return item.key === d.properties.name; })[0].value))
		.attr("fill-opacity", 0.6)
		// .on("mouseover", d=> myMouseOverFunction(d))
		// .on("mouseout", myMouseOutFunction)
		.on("click", function(d){
			//d3.select(this).attr("fill", "green")
			//alert(d.properties.name)
			refit(d3.select(this));
			zoomIn(d);
		})
		//
		//  function myMouseOverFunction(d) {
		// 	//var poly = d3.select(this);
		//
		// 	// show infobox div on mouseover.
		// 	// block means sorta "render on the page" whereas none would mean "don't render at all"
		// 	d3.select(".infobox").style("display", "block")
		// 	d3.select("p").text(d.properties.name);
		// }
		//
		// function myMouseOutFunction() {
		// 	d3.select(".infobox").style("display", "none");
		// }
		//
		// function myMouseMoveFunction() {
		// 	// save selection of infobox so that we can later change it's position
		// 	var infobox = d3.select(".infobox");
		// 	// this returns x,y coordinates of the mouse in relation to our svg canvas
		// 	var coord = d3.svg.mouse(this)
		// 	// now we just position the infobox roughly where our mouse is
		// 	infobox.style("left", coord[0] + 15  + "px" );
		// 	infobox.style("top", coord[1] + "px");
		// }


		g.selectAll("path").data(data.features).exit().remove()

		map.on("moveend", update);

		update();

		yearChart.on('filtered', function(chart) {
      featureElement.attr("fill", d => color(areaGroup.all().filter(function(item) { return item.key === d.properties.name; })[0].value));
	  });

		function update() {
			featureElement.attr("d", path);
		}

		function zoomIn(d){
			//need to return a selected geojson with matching id
			map_level="continent";//d.properties.Type
			d3.csv("data/MetCountry.csv",drawCharts) // change to request zoom level data
		}



		function refit(obj){
			var bounds = obj.node().getBBox();
			console.log("corner in x,y space: " + L.point(bounds.x,bounds.y));
			console.log("lower corner in x,y space: " +L.point(bounds.x+bounds.width,bounds.y+bounds.height));
			var b = [map.layerPointToLatLng(L.point(bounds.x,bounds.y)),map.layerPointToLatLng(L.point(bounds.x+bounds.width,bounds.y+bounds.height))];
			console.log("corner in lat,lng space: " + b[0]);
			console.log("corner in lat,lng space: " + b[1])		;
			map.fitBounds(b);
		}
	}
}

function zoomOut(){
	//need to return a selected geojson with matching id
	map_level="world";//d.properties.type
	map.setView([0, 0], 2)
	d3.csv("data/MetCountry.csv",drawCharts)//change to request zoom level data
}

</script>

</body>
</html>
